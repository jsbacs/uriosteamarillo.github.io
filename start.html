<!DOCTYPE html>
<html>
<body onload="myFunction()">

<h1>Hello World!</h1>

<script>
// This client ID expects the redirect URL to be http://localhost:8080/
       const clientId = 'f6cd8f0d-3c1f-441b-a2ff-3c920a8bcca4';
		const redirectUri = window.location.href;

		// Set Genesys Cloud objects
		const platformClient = require('platformClient');
		const client = platformClient.ApiClient.instance;
		const notificationsApi = new platformClient.NotificationsApi();
		const presenceApi = new platformClient.PresenceApi();
		const usersApi = new platformClient.UsersApi();

		// Set Genesys Cloud settings
		client.setEnvironment('mypurecloud.com');
		client.setPersistSettings(true, 'test_app');

		// Local vars
		let presences = {};
		let userPresenceTopic = '';
		let webSocket = null;
		let me, notificationChannel;

		$(document).ready(() => {
			// Authenticate with Genesys Cloud
			client.loginImplicitGrant(clientId, redirectUri)
				.then(() => {
					console.log('Logged in');

					// Get presences
					return presenceApi.getPresencedefinitions({ pageSize: 100 });
				})
				.then((presenceListing) => {
					console.log(`Found ${presenceListing.entities.length} presences`);

					// Create button for each presence
					presenceListing.entities.forEach((presence) => {
						presences[presence.id] = presence;
						$('div#presenceButtons').append($('<button>')
							.addClass('btn btn-primary')
							.click(() => setPresence(presence.id))
							.text(presence.languageLabels.en_US)
						);
					});

					// Get authenticated user's data, including current presence
					return usersApi.getUsersMe({ expand: ['presence'] });
				})
				.then((userMe) => {
					me = userMe;

					
					// Set current presence text in UI
					$('#currentPresence').text(presences[me.presence.presenceDefinition.id].languageLabels.en_US);

					// Create notification channel
					return notificationsApi.postNotificationsChannels();
				})
				.then((channel) => {
					console.log('channel: ', channel);
					notificationChannel = channel;

					// Set up web socket
					webSocket = new WebSocket(notificationChannel.connectUri);
					webSocket.onmessage = handleNotification;

					// Subscribe to authenticated user's presence
					userPresenceTopic = `v2.users.${me.id}.presence`;
					const body = [ { id: userPresenceTopic } ];
					return notificationsApi.putNotificationsChannelSubscriptions(notificationChannel.id, body);
				})
				.then((channel) => {
					console.log('Channel subscriptions set successfully');

				})
				.catch((err) => console.error(err));
		});

		function setPresence(presenceId) {
			console.log(`Setting presence to ${presences[presenceId].languageLabels.en_US} (${presenceId})`);

			// Set presence
			presenceApi.patchUserPresence(me.id, 'PURECLOUD', { presenceDefinition:{ id: presenceId } })
				.then(() => {
					console.log('Presence set successfully');
				})
				.catch((err) => console.error(err));
		}


		// Handle incoming Genesys Cloud notification from WebSocket
		function handleNotification(message) {
			// Parse notification string to a JSON object
			const notification = JSON.parse(message.data);

			// Discard unwanted notifications
			if (notification.topicName.toLowerCase() === 'channel.metadata') {
				// Heartbeat
				console.info('Ignoring metadata: ', notification);
				return;
			} else if (notification.topicName.toLowerCase() !== userPresenceTopic.toLowerCase()) {
				// Unexpected topic
				console.warn('Unknown notification: ', notification);
				return;
			} else {
				console.debug('Presence notification: ', notification);
			}

			// Set current presence text in UI
			$('#currentPresence').text(presences[notification.eventBody.presenceDefinition.id].languageLabels.en_US);

			// Log messages
			$('div#messages').append($('<pre>').text(`${new Date().toLocaleTimeString()} - ${JSON.stringify(notification,null,2)}`));
		}
function myFunction() {
 const urlParams = new URLSearchParams(window.location.search);
 
 window.open("genesyscloud://" + urlParams);

}
</script>

</body>
</html>
